<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shanti Machinery Works - Tender List</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      display: flex;
      background: #f9f9f9;
    }

    #filters {
      width: 240px;
      border-right: 1px solid #ccc;
      padding-right: 20px;
      box-sizing: border-box;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 0 8px rgb(0 0 0 / 0.1);
    }

    #filters h3 {
      margin-top: 0;
      font-size: 1.4em;
      padding-bottom: 8px;
      border-bottom: 1px solid #ddd;
    }

    .filter-group {
      margin-bottom: 20px;
    }

    .filter-group h4 {
      margin-bottom: 8px;
      font-size: 1.1em;
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 4px;
    }

    .filter-group label {
      display: block;
      margin-bottom: 6px;
      cursor: pointer;
      user-select: none;
    }

    #table-container {
      flex: 1;
      padding-left: 30px;
      box-sizing: border-box;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 0 10px rgb(0 0 0 / 0.1);
    }

    th, td {
      padding: 10px 12px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 14px;
    }

    th {
      background: #f1f1f1;
    }

    #clearFiltersBtn {
      background: #0073e6;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
      width: 100%;
    }

    #clearFiltersBtn:hover {
      background: #005bb5;
    }
  </style>
</head>
<body>

  <div id="filters">
    <h3>Filters</h3>

    <div class="filter-group" id="departmentFilterGroup">
      <h4>Department</h4>
      <!-- Dept checkboxes go here -->
    </div>

    <div class="filter-group" id="organisationFilterGroup">
      <h4>Organisation</h4>
      <!-- Org checkboxes go here -->
    </div>

    <div class="filter-group" id="emdFilterGroup">
      <h4>EMD?</h4>
      <!-- EMD checkboxes go here -->
    </div>

    <button id="clearFiltersBtn">Clear Filters</button>
  </div>

  <div id="table-container">
    <h1>Shanti Machinery Works - Tender List</h1>
    <table id="tender-table">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQP7fgbl24sR0EAC4CvyGoeKWJFiA7l1rojSgIntZNo8Swu04V14X8M_6LGVC61qlfPrUdc2nzUIKFK/pub?gid=1976447959&single=true&output=csv";

    let headers = [];
    let dataRows = [];

    // Utility to parse CSV row (simple)
    function parseCSVRow(row) {
      const result = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < row.length; i++) {
        const char = row[i];
        if (char === '"' && (i === 0 || row[i - 1] !== '\\')) {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim().replace(/^"|"$/g, ''));
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim().replace(/^"|"$/g, ''));
      return result;
    }

    function buildTable(headers, data) {
      const thead = document.querySelector("#tender-table thead");
      const tbody = document.querySelector("#tender-table tbody");

      thead.innerHTML = '';
      tbody.innerHTML = '';

      // Build header row
      const headerRow = document.createElement("tr");
      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);

      // Build data rows
      data.forEach(row => {
        const tr = document.createElement("tr");
        row.forEach(cell => {
          const td = document.createElement("td");
          td.textContent = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function populateCheckboxFilters(columnName, containerId) {
      const colIndex = headers.indexOf(columnName);
      if (colIndex === -1) return;

      const container = document.getElementById(containerId);
      container.innerHTML = `<h4>${columnName}</h4>`; // reset

      // Unique sorted values
      const uniqueVals = [...new Set(dataRows.map(row => row[colIndex]).filter(Boolean))].sort();

      uniqueVals.forEach(val => {
        const id = `${containerId}_${val.replace(/\s+/g, '_')}`;
        const label = document.createElement("label");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.name = columnName.toLowerCase();
        checkbox.value = val;
        checkbox.id = id;

        label.htmlFor = id;
        label.appendChild(checkbox);
        label.append(` ${val}`);

        container.appendChild(label);
      });
    }

    function setupFilterListeners() {
      // Add event listeners to all filter checkboxes
      document.querySelectorAll('#filters input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', applyFilters);
      });

      // Clear filters button
      document.getElementById("clearFiltersBtn").addEventListener("click", () => {
        document.querySelectorAll('#filters input[type="checkbox"]').forEach(cb => cb.checked = false);
        applyFilters();
      });
    }

    function applyFilters() {
      const selectedDepartments = Array.from(document.querySelectorAll('input[name="department"]:checked')).map(cb => cb.value.toLowerCase());
      const selectedOrganisations = Array.from(document.querySelectorAll('input[name="organisation"]:checked')).map(cb => cb.value.toLowerCase());
      const selectedEMD = Array.from(document.querySelectorAll('input[name="emd?"]:checked')).map(cb => cb.value.toLowerCase());

      const tbody = document.querySelector("#tender-table tbody");
      const rows = tbody.querySelectorAll("tr");

      const depIndex = headers.indexOf("Department");
      const orgIndex = headers.indexOf("Organisation");
      const emdIndex = headers.indexOf("EMD?");

      rows.forEach(row => {
        const cells = row.querySelectorAll("td");

        const depVal = cells[depIndex].textContent.toLowerCase();
        const orgVal = cells[orgIndex].textContent.toLowerCase();
        const emdVal = cells[emdIndex].textContent.toLowerCase();

        // Filter logic:
        // Show if matches any selected in a filter group OR no selection in that group,
        // And all groups must match

        const depMatch = selectedDepartments.length === 0 || selectedDepartments.includes(depVal);
        const orgMatch = selectedOrganisations.length === 0 || selectedOrganisations.includes(orgVal);
        const emdMatch = selectedEMD.length === 0 || selectedEMD.includes(emdVal);

        if (depMatch && orgMatch && emdMatch) {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      });
    }

    // Fetch CSV and initialize
    fetch(csvUrl)
      .then(res => res.text())
      .then(csv => {
        const rows = csv.trim().split("\n").map(parseCSVRow);
        headers = rows[0];
        dataRows = rows.slice(1);

        buildTable(headers, dataRows);

        // Populate filters for these columns
        populateCheckboxFilters("Department", "departmentFilterGroup");
        populateCheckboxFilters("Organisation", "organisationFilterGroup");
        populateCheckboxFilters("EMD?", "emdFilterGroup");

        setupFilterListeners();
      });
  </script>

</body>
</html>
